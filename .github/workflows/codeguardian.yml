name: CodeGuardian Review
on:
  pull_request:
    types: [opened, synchronize]

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review"
        required: true
        type: string

  issue_comment:
    types: [created]

concurrency:
  group: codeguardian-${{ github.event.pull_request.number || github.event.issue.number || github.event.inputs.pr_number || github.run_id }}
  cancel-in-progress: true

jobs:
  review-pr:
    if: github.event_name == 'pull_request'
    uses: blackas/CodeGuardian/.github/workflows/reusable-review.yml@main
    permissions:
      contents: read
      pull-requests: write
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  review-manual:
    if: github.event_name == 'workflow_dispatch'
    uses: blackas/CodeGuardian/.github/workflows/reusable-review.yml@main
    permissions:
      contents: read
      pull-requests: write
    with:
      pr_number: ${{ github.event.inputs.pr_number }}
      repo_name: ${{ github.repository }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  review-comment:
    if: >-
      github.event_name == 'issue_comment' &&
      github.event.action == 'created' &&
      contains(github.event.comment.body, '/review') &&
      github.event.issue.pull_request
    uses: blackas/CodeGuardian/.github/workflows/reusable-review.yml@main
    permissions:
      contents: read
      pull-requests: write
    with:
      pr_number: ${{ github.event.issue.number }}
      repo_name: ${{ github.repository }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
